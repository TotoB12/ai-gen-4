<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TotoB12 Gen 4</title>
    <link rel="icon" href="https://raw.githubusercontent.com/TotoB12/totob12.github.io/main/things/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
  
    <style>
        body, input, textarea {
            font-family: 'Roboto', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
        }

        body {
          background-color: #1a1a1a;
        }

        h1 {
            text-align: center;
            font-weight: 500;
            margin: 16px;
            color: #ffffff;
        }

        #chat-container {
            flex: 1;
            margin: 0 auto;
            background-color: #1a1a1a;
            padding: 16px;
            overflow: auto;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        .message {
            display: flex;
            margin-bottom: 10px;
            font-size: 16px;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message, .system-message {
            justify-content: flex-start;
        }

        .message-text {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 20px;
            max-width: 70%;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .user-message .message-text {
            background-color: #41729f;
            color: #ffffff;
        }

        .system-message .message-text {
            background-color: transparent;
            color: #666;
            font-style: italic;
            border: none;
        }

        #chat-form {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            padding: 16px;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            background-color: #2b2b2b;
        }

        #message {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border-radius: 20px;
            border: none;
            margin-right: 8px;
            outline: none;
            background-color: #3a3a3a;
            color: #ffffff;
            resize: none;
            overflow-y: auto;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 20px;
            border: none;
            background-color: #41729f;
            color: #ffffff;
            cursor: pointer;
            outline: none;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1e345b;
        }

        @keyframes typing {
          0% {
            opacity: 0;
            width: 0;
          }
          20% {
            opacity: 1;
            width: 0;
          }
          80% {
            opacity: 1;
            width: 4px;
          }
          100% {
            opacity: 0;
            width: 0;
          }
        }
        
        .dots-animation span {
          display: inline-block;
          animation: typing 2s infinite;
          animation-timing-function: steps(4);
        }
        
        .dots-animation span:nth-child(1) {
          animation-delay: 0s;
        }
        
        .dots-animation span:nth-child(2) {
          animation-delay: 0.4s;
        }
        
        .dots-animation span:nth-child(3) {
          animation-delay: 0.8s;
        }

        .generating-message .message-text {
          background-color: #ccc;
          color: #666;
        }

    </style>
</head>
<body>
    <h1>TotoB12 Gen 4</h1>
    <div id="chat-container"></div>
    <form id="chat-form">
        <textarea id="message" name="message" required placeholder="Type your message..." rows="1"></textarea>
        <button type="submit" style="margin-right: 7px;">Send</button>
        <button type="button" id="clear-history">Clear History</button>
    </form>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Initialize an array to store the conversation history
        let conversationHistory = [];

        // Function to load the conversation history from localStorage
        function loadConversationHistory() {
            const storedHistory = localStorage.getItem("conversationHistory");
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                conversationHistory.forEach(message => {
                    // Use the addMessage function to display the messages with proper code snippet handling
                    addMessage(message.content, message.role === "user" ? "user" : "bot");
                });
            } else {
                // Display the welcome message if there's no stored history
                displayWelcomeMessage();
            }
        }

        function clearHistory() {
            // Clear the chat container
            const chatContainer = document.getElementById("chat-container");
            chatContainer.innerHTML = '';

            // Clear the conversation history array
            conversationHistory = [];

            // Clear the conversation history from localStorage
            localStorage.removeItem("conversationHistory");

            // Display the welcome message again
            displayWelcomeMessage();
        }

        // Function to save the conversation history to localStorage
        function saveConversationHistory() {
            localStorage.setItem("conversationHistory", JSON.stringify(conversationHistory));
        }

        // Function to add a message to the chat container
        function addMessage(message, sender, additionalClass) {
          const chatContainer = document.getElementById("chat-container");
          const messageElement = document.createElement("div");
          messageElement.className = `message ${sender}-message ${additionalClass}`;
        
          const messageText = document.createElement("pre");
          messageText.style.whiteSpace = "pre-wrap";
          messageText.style.fontFamily = "'Roboto', sans-serif";
          messageText.style.whiteSpace = "pre-wrap";
          messageText.className = "message-text";
        
          const codeSnippetRegex = /```(\w+)\n([\s\S]*?)\n```/g;
          let lastIndex = 0;
          let match;
          while ((match = codeSnippetRegex.exec(message)) !== null) {
            // Add the plain text before the code snippet
            const plainText = message.substring(lastIndex, match.index);
            const escapedText = plainText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            messageText.insertAdjacentHTML("beforeend", escapedText);
        
            // Add the code snippet with syntax highlighting
            const language = match[1];
            const code = match[2];
            const codeElement = document.createElement("code");
            codeElement.className = language;
            codeElement.textContent = code;
        
            // Highlight the code using highlight.js
            hljs.highlightElement(codeElement);
        
            const codeContainer = document.createElement("pre");
            codeContainer.appendChild(codeElement);
            messageText.appendChild(codeContainer);
        
            lastIndex = codeSnippetRegex.lastIndex;
          }
        
          // Add the remaining plain text after the last code snippet
          const remainingText = message.substring(lastIndex);
          const escapedRemainingText = remainingText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          messageText.insertAdjacentHTML("beforeend", escapedRemainingText);
        
          messageElement.appendChild(messageText);
          chatContainer.appendChild(messageElement);
        
          // Scroll to the bottom of the chat container
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    
        // Function to display the welcome message from the bot
        function displayWelcomeMessage() {
            const welcomeMessage = "Hello! I'm TotoB12. How can I help you today?";
            addMessage(welcomeMessage, "bot");
        }
    
        // Function to display a temporary "Generating response..." message from the bot
        function displayGeneratingMessage() {
          const generatingMessage = "Generating response";
          addMessage(generatingMessage, "bot", "generating-message");
        
          // Add the typing animation for the dots
          const dotsContainer = document.createElement("span");
          dotsContainer.className = "dots-animation";
          const dot1 = document.createElement("span");
          dot1.textContent = ".";
          const dot2 = document.createElement("span");
          dot2.textContent = ".";
          const dot3 = document.createElement("span");
          dot3.textContent = ".";
        
          dotsContainer.appendChild(dot1);
          dotsContainer.appendChild(dot2);
          dotsContainer.appendChild(dot3);
        
          const messageElement = document.querySelector(".generating-message .message-text");
          messageElement.appendChild(dotsContainer);
        
          return generatingMessage;
        }
    
        // Function to remove the "Generating response..." message from the chat container
        function removeGeneratingMessage() {
          const chatContainer = document.getElementById("chat-container");
          const generatingMessageElement = chatContainer.querySelector(".generating-message");
          if (generatingMessageElement) {
            chatContainer.removeChild(generatingMessageElement);
          }
        }
    
        // Event listener for the form submission
        document.getElementById("chat-form").addEventListener("submit", function(event) {
            event.preventDefault();

            const input = document.getElementById("message");
            const message = input.value.trim();

            // Do not proceed if the message is empty
            if (message.length === 0) {
                return;
            }

            // Display the user's message and update the conversation history
            addMessage(message, "user");
            conversationHistory.push({ role: "user", content: message });
            saveConversationHistory(); // Save the updated conversation history to localStorage

            input.value = "";
            input.style.height = "";
            input.focus();

            // Display the "Generating response..." message
            const generatingMessage = displayGeneratingMessage();
            const additionalClass = (generatingMessage === "Generating response...") ? "generating-message" : "";

            // Send a request to the server to generate a response
            fetch("/generate", {
                method: "POST",
                body: JSON.stringify({ message: message, history: conversationHistory }),
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                }
            })

          .then(response => response.json())
          .then(data => {
            // Remove the "Generating response..." message
            removeGeneratingMessage();
          
            // Save the response to the conversation history
            conversationHistory.push({ role: "assistant", content: data });
            saveConversationHistory(); // Save the updated conversation history to localStorage
          
            // Display the response message
            addMessage(data, "bot");
          });
        });

        // Event listener for the "Clear History" button
        document.getElementById("clear-history").addEventListener("click", function() {
            clearHistory();
        });

        // Function to adjust the textarea height based on its content

        function adjustTextareaHeight(textarea) {
            textarea.style.height = "auto"; // Reset the height to auto
            const maxHeight = window.innerHeight * 0.3; // Calculate the maximum height (30% of the screen height)
            const newHeight = Math.min(textarea.scrollHeight, maxHeight); // Calculate the new height
            textarea.style.height = newHeight + "px"; // Set the height to the new height
        
            // Reset the height to its default size if the content is empty or only one line
            if (textarea.value.trim().length === 0 || textarea.value.split("\n").length === 1) {
                textarea.style.height = "";
            }
        }

        document.getElementById("message").addEventListener("blur", function() {
          adjustTextareaHeight(this);
      });

        // Event listener for the textarea input event
        document.getElementById("message").addEventListener("input", function() {
            adjustTextareaHeight(this);
        });

        // Event listener for the textarea keydown event
        document.getElementById("message").addEventListener("keydown", function(event) {
            // If the Enter key is pressed
            if (event.key === "Enter") {
                // If the Shift key is not pressed, submit the form
                if (!event.shiftKey) {
                    event.preventDefault();
                    document.getElementById("chat-form").dispatchEvent(new Event("submit"));
                }
            }
        });

        // Load the conversation history when the page loads
        loadConversationHistory();

        // Adjust the textarea height when the page loads
        adjustTextareaHeight(document.getElementById("message"));

      });
    </script>
    
</body>
</html>
