<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TotoB12 AI Gen-4</title>
    <link rel="icon" href="https://raw.githubusercontent.com/TotoB12/totob12.github.io/main/things/favicon.ico">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/TotoB12/totob12.github.io/main/things/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
    <link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/atom-one-dark.css">
    <link rel="stylesheet" href="static/style.css">
</head>
  
<body>
    <h1><img onclick='window.open("https://totob12.github.io/", "_blank")' src='static/gen-4-totob12-title.svg' alt='totob12 logo'></h1>
    <div id="chat-container"></div>
    <form id="chat-form">
        <div class='clear-history-container'>
          <button type="button" id="clear-history" class="clear-history-button">
            <span class="material-symbols-outlined">autorenew</span>Clear history
          </button>
        </div>
        <textarea id="message" name="message" required placeholder="Type your message..." rows="1"></textarea>
        <button type="submit" style="margin-right: 7px;">Send</button>
    </form>
  <!-- <hide style="visibility: hidden;">
  <a href='https://acadooghostwriter.com/'>ACADOOghostwriter.com</a>
  <script type='text/javascript' src='https://www.freevisitorcounters.com/auth.php?id=c4a6974f72e01af600dfc841f0cd27be90c66353'></script>
  <script type="text/javascript" src="https://www.freevisitorcounters.com/en/home/counter/1016274/t/4"></script>
</hide> -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        let conversationHistory = [];
        function loadConversationHistory() {
            const storedHistory = localStorage.getItem("conversationHistory");
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                conversationHistory.forEach(message => {
                    addMessage(message.content, message.role === "user" ? "user" : "bot");
                });
            } else {
                displayWelcomeMessage();
            }
        }
        function clearHistory() {
            const chatContainer = document.getElementById("chat-container");
            chatContainer.innerHTML = '';
            conversationHistory = [];
            localStorage.removeItem("conversationHistory");
            displayWelcomeMessage();
        }
        function saveConversationHistory() {
            localStorage.setItem("conversationHistory", JSON.stringify(conversationHistory));
        }

        
  function addMessage(message, sender, additionalClass) {
    const chatContainer = document.getElementById("chat-container");
    const messageElement = document.createElement("div");
    messageElement.className = `message ${sender}-message ${additionalClass}`;
    const messageText = document.createElement("pre");
    messageText.style.whiteSpace = "pre-wrap";
    messageText.style.fontFamily = "'Roboto', sans-serif";
    messageText.style.whiteSpace = "pre-wrap";
    messageText.className = "message-text";

    const imageRegex = /\[(.*?)\]/g;
    let lastIndex = 0;
    let match;
    while ((match = imageRegex.exec(message)) !== null) {
      const plainText = message.substring(lastIndex, match.index);
      const escapedText = plainText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      messageText.insertAdjacentHTML("beforeend", escapedText);

      const imageLink = match[1];
      const imageElement = document.createElement("img");
      imageElement.src = imageLink;
      imageElement.style.maxWidth = "100%";
      imageElement.style.height = "auto";
      const imageContainer = document.createElement("div");
      imageContainer.className = "image-container";
      imageContainer.appendChild(imageElement);
      messageText.appendChild(imageContainer);

      lastIndex = imageRegex.lastIndex;
    }

    const remainingText = message.substring(lastIndex);
    const escapedRemainingText = remainingText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    messageText.insertAdjacentHTML("beforeend", escapedRemainingText);
    messageElement.appendChild(messageText);
    chatContainer.appendChild(messageElement);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
        
        function displayWelcomeMessage() {
            const welcomeMessage = "Hello! I'm TotoB12. How can I help you today?";
            addMessage(welcomeMessage, "bot");
        }
        function displayGeneratingMessage() {
          const generatingMessage = "Generating response";
          addMessage(generatingMessage, "bot", "generating-message");
          const dotsContainer = document.createElement("span");
          dotsContainer.className = "dots-animation";
          const dot1 = document.createElement("span");
          dot1.textContent = ".";
          const dot2 = document.createElement("span");
          dot2.textContent = ".";
          const dot3 = document.createElement("span");
          dot3.textContent = ".";
          dotsContainer.appendChild(dot1);
          dotsContainer.appendChild(dot2);
          dotsContainer.appendChild(dot3);
          const messageElement = document.querySelector(".generating-message .message-text");
          messageElement.appendChild(dotsContainer);
          return generatingMessage;
        }
        function removeGeneratingMessage() {
          const chatContainer = document.getElementById("chat-container");
          const generatingMessageElement = chatContainer.querySelector(".generating-message");
          if (generatingMessageElement) {
            chatContainer.removeChild(generatingMessageElement);
          }
        }
        document.getElementById("chat-form").addEventListener("submit", function(event) {
            event.preventDefault();
            const input = document.getElementById("message");
            const message = input.value.trim();
            if (message.length === 0) {
                return;
            }
            addMessage(message, "user");
            conversationHistory.push({ role: "user", content: message });
            saveConversationHistory();
            input.value = "";
            input.style.height = "";
            input.focus();
            const generatingMessage = displayGeneratingMessage();
            const additionalClass = (generatingMessage === "Generating response...") ? "generating-message" : "";
            fetch("/generate", {
                method: "POST",
                body: JSON.stringify({ message: message, history: conversationHistory }),
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                }
            })
          .then(response => response.json())
          .then(data => {
            removeGeneratingMessage();
            conversationHistory.push({ role: "assistant", content: data });
            saveConversationHistory();
            addMessage(data, "bot");
          });
        });
        document.getElementById("clear-history").addEventListener("click", function() {
            clearHistory();
        });
        function adjustTextareaHeight(textarea) {
            textarea.style.height = "auto";
            const maxHeight = window.innerHeight * 0.3;
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = newHeight + "px";
            if (textarea.value.trim().length === 0 || textarea.value.split("\n").length === 1) {
                textarea.style.height = "";
            }
        }
        document.getElementById("message").addEventListener("blur", function() {
          adjustTextareaHeight(this);
      });
        document.getElementById("message").addEventListener("input", function() {
            adjustTextareaHeight(this);
        });
        document.getElementById("message").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                if (!event.shiftKey) {
                    event.preventDefault();
                    document.getElementById("chat-form").dispatchEvent(new Event("submit"));
                }
            }
        });
        loadConversationHistory();
        adjustTextareaHeight(document.getElementById("message"));
      });
    </script>
</body>
</html>
